// Prisma schema for rooMate

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?
  name          String
  phone         String?
  avatar        String?
  bio           String?
  dateOfBirth   DateTime?
  gender        Gender?
  occupation    Occupation?
  verified      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // No-show tracking
  noShowCount   Int       @default(0)
  blockedUntil  DateTime?

  // Relations
  landlordProfile  LandlordProfile?
  tenantProfile    TenantProfile?
  listings         Listing[]
  bookings         Booking[]
  messages         Message[]
  reviews          Review[]
  favorites        Favorite[]
  interests        Interest[]
  wishes           Wish[]
  groupMemberships GroupMembership[]
  certificationRequests CertificationRequest[]
  feedbacks        Feedback[]

  @@map("users")
}

model LandlordProfile {
  id             String  @id @default(cuid())
  userId         String  @unique
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  responseRate   Float   @default(0)
  responseTime   Int     @default(0) // in minutes
  totalListings  Int     @default(0)

  // Contact preferences
  contactPreference ContactPreference @default(IN_APP)
  phonePublic       Boolean           @default(false)
  emailPublic       Boolean           @default(false)

  // Business info
  companyName    String?
  description    String?

  // Verification
  idVerified     Boolean @default(false)
  phoneVerified  Boolean @default(false)

  @@map("landlord_profiles")
}

enum ContactPreference {
  IN_APP
  PHONE
  EMAIL
}

model TenantProfile {
  id             String  @id @default(cuid())
  userId         String  @unique
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Preferences
  budgetMin      Int?
  budgetMax      Int?
  preferredAreas String[]
  moveInDate     DateTime?

  // Screening info
  contractType        ContractType?
  smoker              Boolean       @default(false)
  hasPets             Boolean       @default(false)
  hasGuarantor        Boolean       @default(false)
  incomeRange         IncomeRange?
  languages           String[]
  referencesAvailable Boolean       @default(false)

  // Verification
  employmentVerified Boolean @default(false)
  incomeVerified     Boolean @default(false)

  @@map("tenant_profiles")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Occupation {
  STUDENT
  WORKING
  FREELANCER
  UNEMPLOYED
  RETIRED
}

enum ContractType {
  PERMANENT   // Permanent contract
  TEMPORARY   // Fixed-term contract
  INTERNSHIP  // Internship/Traineeship
}

enum IncomeRange {
  UNDER_1000
  FROM_1000_TO_1500
  FROM_1500_TO_2000
  FROM_2000_TO_3000
  OVER_3000
}

// ==================== LISTINGS ====================

model Listing {
  id            String      @id @default(cuid())
  landlordId    String?
  landlord      User?       @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  
  // Basic info
  title         String
  description   String
  status        ListingStatus @default(DRAFT)
  
  // Location
  address       String
  city          String
  neighborhood  String?
  postalCode    String?
  latitude      Float
  longitude     Float
  
  // Room details
  roomType      RoomType
  roomSize      Int         // in m²
  totalSize     Int?        // apartment total size
  floor         Int?
  hasElevator   Boolean     @default(false)
  
  // House metadata
  totalRooms    Int?
  bathrooms     Int?
  specialAreas  String[]    // ["Lavanderia", "Salotto", ...]
  
  // Pricing
  price         Int         // monthly rent
  expenses      Int         @default(0)
  deposit       Int
  
  // Pricing breakdown
  allInclusive      Boolean @default(false)
  electricityGas    Int?    // estimated monthly per person
  water             Int?
  heatingCost       Int?
  condominiumFees   Int?
  cleaningIncluded  Boolean @default(false)
  cleaningFrequency String? // weekly, biweekly, monthly
  cleaningHours     String?
  cleaningArea      String? // common, all
  expenseNotes      String?
  
  // Contract details
  contractType        String?   // transitorio, studenti, 4+4, 3+2, etc.
  contractStartDate   DateTime?
  contractEndDate     DateTime?
  contractMinDuration Int?      // months
  contractMaxDuration Int?      // months
  renewalPossible     Boolean?
  renewalConditions   String?
  residenceAllowed    Boolean?
  domicileAllowed     Boolean?
  outOfTownOnly       Boolean   @default(false)
  outOfTownNote       String?
  
  // Contact preference for publisher
  publisherContactPref String?  // email, phone, app
  
  // Availability
  availableFrom DateTime
  minStay       Int         @default(6) // months
  maxStay       Int?
  
  // Features
  features      ListingFeatures?
  
  // Rules & preferences
  rules         ListingRules?
  preferences   ListingPreferences?
  
  // Media
  images        ListingImage[]
  virtualTourUrl String?
  videoUrl       String?
  
  // Current roommates
  roommates     Roommate[]
  
  // Bookings & visits
  availableSlots VisitSlot[]
  bookings       Booking[]
  
  // Engagement
  views         Int         @default(0)
  favorites     Favorite[]
  reviews       Review[]
  nearbyAmenities NearbyAmenity[]
  interests     Interest[]

  // Anonymous publishing (no-registration flow)
  editToken     String?     @unique  // URL token for anonymous editing
  editCode      String?              // 6-digit code to access edit page
  contactEmail  String?              // public contact email (no-reg)
  contactPhone  String?              // public contact phone (no-reg)
  isAnonymous   Boolean     @default(false) // true if published without account
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  publishedAt   DateTime?
  expiresAt     DateTime?

  @@index([city])
  @@index([price])
  @@index([status])
  @@index([expiresAt])
  @@map("listings")
}

model ListingImage {
  id         String  @id @default(cuid())
  listingId  String
  listing    Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  url        String
  order      Int     @default(0)
  caption    String?
  
  @@map("listing_images")
}

model ListingFeatures {
  id             String  @id @default(cuid())
  listingId      String  @unique
  listing        Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  wifi           Boolean @default(false)
  furnished      Boolean @default(false)
  privateBath    Boolean @default(false)
  balcony        Boolean @default(false)
  aircon         Boolean @default(false)
  heating        Boolean @default(true)
  washingMachine Boolean @default(false)
  dishwasher     Boolean @default(false)
  parking        Boolean @default(false)
  garden         Boolean @default(false)
  terrace        Boolean @default(false)
  
  @@map("listing_features")
}

model ListingRules {
  id               String  @id @default(cuid())
  listingId        String  @unique
  listing          Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  petsAllowed      Boolean @default(false)
  smokingAllowed   Boolean @default(false)
  couplesAllowed   Boolean @default(false)
  guestsAllowed    Boolean @default(true)
  cleaningSchedule String?
  quietHoursEnabled Boolean @default(false)
  quietHoursStart  String? // "22:00"
  quietHoursEnd    String? // "08:00"
  
  @@map("listing_rules")
}

model ListingPreferences {
  id           String       @id @default(cuid())
  listingId    String       @unique
  listing      Listing      @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  gender       Gender?      // null = any
  ageMin       Int?
  ageMax       Int?
  occupation   Occupation[]
  languages    String[]
  
  @@map("listing_preferences")
}

model Roommate {
  id          String  @id @default(cuid())
  listingId   String
  listing     Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  name        String
  age         Int?
  gender      String?   // MALE, FEMALE
  occupation  String?   // Studente, Lavoratore
  bio         String?   @db.VarChar(200)
  avatar      String?
  
  @@map("roommates")
}

enum ListingStatus {
  DRAFT
  ACTIVE
  QUEUE_FULL  // 3 interested tenants — hidden from search
  PAUSED
  RENTED
  ARCHIVED
  EXPIRED
}

enum RoomType {
  SINGLE
  DOUBLE
  STUDIO
  ENTIRE_PLACE
}

// ==================== VISITS & BOOKINGS ====================

model VisitSlot {
  id          String    @id @default(cuid())
  listingId   String
  listing     Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  date        DateTime
  startTime   String    // "10:00"
  endTime     String    // "10:30"
  type        VisitType
  maxGuests   Int       @default(1) // for open days
  
  bookings    Booking[]
  
  createdAt   DateTime  @default(now())
  
  @@index([listingId, date])
  @@map("visit_slots")
}

model Booking {
  id          String        @id @default(cuid())
  slotId      String
  slot        VisitSlot     @relation(fields: [slotId], references: [id], onDelete: Cascade)
  listingId   String
  listing     Listing       @relation(fields: [listingId], references: [id])
  tenantId    String
  tenant      User          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  status      BookingStatus @default(PENDING)
  message     String?       // message to landlord
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  confirmedAt DateTime?
  cancelledAt DateTime?
  
  @@unique([slotId, tenantId])
  @@map("bookings")
}

enum VisitType {
  SINGLE     // one-on-one visit
  OPENDAY    // multiple visitors allowed
  VIRTUAL    // video call
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

// ==================== MESSAGING ====================

model Conversation {
  id          String    @id @default(cuid())
  listingId   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  participants   ConversationParticipant[]
  messages       Message[]
  housemateGroup HousemateGroup?

  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  
  lastReadAt     DateTime?
  
  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  content        String
  
  createdAt      DateTime     @default(now())
  readAt         DateTime?
  
  @@index([conversationId, createdAt])
  @@map("messages")
}

// ==================== REVIEWS & FAVORITES ====================

model Review {
  id          String   @id @default(cuid())
  listingId   String
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  rating      Int      // 1-5
  comment     String?
  
  createdAt   DateTime @default(now())
  
  @@unique([listingId, authorId])
  @@map("reviews")
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId  String
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([userId, listingId])
  @@map("favorites")
}

// ==================== NEARBY AMENITIES ====================

model NearbyAmenity {
  id         String      @id @default(cuid())
  listingId  String
  listing    Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)

  type       AmenityType
  name       String
  latitude   Float
  longitude  Float
  distanceM  Int         // distance in meters from listing

  @@index([listingId, type])
  @@map("nearby_amenities")
}

enum AmenityType {
  SUPERMARKET
  GROCERY
  METRO_STATION
  TRAIN_STATION
  BUS_STOP
  TRAM_STOP
  BICYCLE_PARKING
}

// ==================== INTEREST SYSTEM ====================

model Interest {
  id          String         @id @default(cuid())
  listingId   String
  listing     Listing        @relation(fields: [listingId], references: [id], onDelete: Cascade)
  tenantId    String
  tenant      User           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Optional group application
  groupId     String?
  group       HousemateGroup? @relation(fields: [groupId], references: [id])

  status              InterestStatus @default(ACTIVE)
  position            Int            @default(0) // 1-3 = active queue
  score               Int            @default(0) // engagement score
  schedulingApproved  Boolean        @default(false) // landlord approved visit scheduling
  removedAt           DateTime?      // when withdrawn/removed (for 24h cooldown)

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  certificationRequests CertificationRequest[]

  @@unique([listingId, tenantId])
  @@index([listingId, status, position])
  @@index([groupId])
  @@map("interests")
}

enum InterestStatus {
  ACTIVE      // Currently in top 3
  WAITING     // On waiting list
  REMOVED     // Landlord removed from queue
  WITHDRAWN   // User withdrew interest
  EXPIRED     // Listing expired
}

// ==================== CERTIFICATION REQUESTS ====================

model CertificationRequest {
  id          String               @id @default(cuid())
  interestId  String
  interest    Interest             @relation(fields: [interestId], references: [id], onDelete: Cascade)
  tenantId    String
  tenant      User                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  type        CertificationType
  status      CertificationStatus  @default(PENDING)
  documentUrl String?              // uploaded proof
  note        String?              // landlord note

  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@unique([interestId, type])
  @@map("certification_requests")
}

enum CertificationType {
  EMPLOYMENT_CONTRACT  // Certifica contratto di lavoro
  INCOME_PROOF         // Certifica reddito
  STUDENT_ENROLLMENT   // Certifica iscrizione universitaria
  GUARANTOR            // Certifica garante
  ID_DOCUMENT          // Documento d'identità
}

enum CertificationStatus {
  PENDING
  SUBMITTED
  VERIFIED
  REJECTED
}

// ==================== WISH SYSTEM (Saved Searches) ====================

model Wish {
  id             String     @id @default(cuid())
  userId         String
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  name           String?    // Optional label for the search
  
  // Search filters
  city           String?
  neighborhoods  String[]
  priceMin       Int?
  priceMax       Int?
  roomTypes      RoomType[]
  
  // Preferences
  minSize        Int?
  features       String[]   // wifi, furnished, etc.
  
  // Notification settings
  emailNotify    Boolean    @default(true)
  pushNotify     Boolean    @default(true)
  
  active         Boolean    @default(true)
  lastMatchedAt  DateTime?
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([userId, active])
  @@map("wishes")
}

// ==================== HOUSEMATE GROUP SYSTEM ====================

enum GroupRole {
  OWNER
  MEMBER
}

enum GroupMemberStatus {
  PENDING    // Invitation sent, awaiting response
  ACCEPTED   // Member accepted the invitation
  DECLINED   // Member declined the invitation
}

model HousemateGroup {
  id             String   @id @default(cuid())
  name           String?
  description    String?
  maxMembers     Int      @default(4)

  // Group chat conversation
  conversationId String?  @unique
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  // Relations
  memberships    GroupMembership[]
  interests      Interest[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("housemate_groups")
}

model GroupMembership {
  id        String            @id @default(cuid())
  groupId   String
  group     HousemateGroup    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId    String
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      GroupRole         @default(MEMBER)
  status    GroupMemberStatus @default(PENDING)
  joinedAt  DateTime?         // Set when status becomes ACCEPTED

  createdAt DateTime          @default(now())

  @@unique([groupId, userId])
  @@index([userId, status])
  @@map("group_memberships")
}

// ==================== FEEDBACK ====================

model Feedback {
  id        String   @id @default(cuid())
  message   String
  rating    Int?     // 1-5 stars (optional)
  page      String?  // URL path where feedback was submitted
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  ip        String?
  createdAt DateTime @default(now())

  @@map("feedbacks")
}

